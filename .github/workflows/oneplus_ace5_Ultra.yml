name: oneplus_ace5_Ultra_android16
on:
  workflow_dispatch:
    inputs:
      KERNEL_SUFFIX:
        description: 'å†…æ ¸åç§°ä¿®æ”¹(å¯æ”¹ä¸­æ–‡å’Œemoji)'
        required: true
        default: '-android16-sukisu-ultra'
      KERNEL_TIME:
        description: "å†…æ ¸æ„å»ºæ—¥æœŸæ›´æ”¹"
        required: true
        default: 'Tue Jan  1 00:00:00 UTC 2026'
      enable_kpm:
        description: "æ˜¯å¦å¯ç”¨ KPM å†…æ ¸æ¨¡å—"
        required: true
        default: false
        type: boolean
      enable_lz4kd:
        description: "æ˜¯å¦å¯ç”¨ LZ4KD å‹ç¼©"
        required: true
        default: true
        type: boolean
      enable_sched_ext:
        description: "æ˜¯å¦å¯ç”¨é£é©°è°ƒåº¦å™¨"
        required: true
        default: true
        type: boolean
      enable_ksu:
        description: "æ˜¯å¦å¯ç”¨ KernelSU"
        required: true
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_DIR: /home/runner/.ccache  
      CCACHE_MAXSIZE: 8G
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          
      - name: Configure Git
        run: |
          git config --global user.name "Android16-Builder"
          git config --global user.email "builder@android16.com"

      - name: Install dependencies
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y python3 git curl ccache libelf-dev build-essential flex bison libssl-dev libncurses-dev zlib1g-dev

      - name: Restore ccache
        uses: actions/cache@v3
        with:
          path: /home/runner/.ccache
          key: ccache-${{ runner.os }}-android16-${{ github.ref }}
          restore-keys: |
            ccache-${{ runner.os }}-android16-

      - name: Install repo tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize Android 16 kernel source
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          echo "æ­£åœ¨åŒæ­¥ Android 16 å†…æ ¸æºç ..."
          
          # ä½¿ç”¨æ”¯æŒ Android 16 çš„ manifest
          repo init -u https://github.com/HanKuCha/kernel_manifest.git -b refs/heads/oneplus/sm8750 -m oneplus_ace5_Ultra.xml --depth=1
          repo --trace sync -c -j$(nproc --all) --no-tags
          
          # æ¸…ç†ä¿æŠ¤å¯¼å‡ºç¬¦å·
          rm -f kernel_platform/common/android/abi_gki_protected_exports_* || echo "No protected exports!"
          rm -f kernel_platform/msm-kernel/android/abi_gki_protected_exports_* || echo "No protected exports!"
         
      - name: Check kernel structure
        run: |
          cd kernel_workspace/kernel_platform
          echo "Android 16 å†…æ ¸ç›®å½•ç»“æ„:"
          find . -name "Makefile" -type f | head -10
          ls -la
          echo "commonç›®å½•å†…å®¹:"
          ls -la common/

      - name: Setup KernelSU for Android 16
        if: ${{ inputs.enable_ksu }}
        run: |
          cd kernel_workspace/kernel_platform
          echo "è®¾ç½® Android 16 KernelSU æ”¯æŒ..."
          
          # ä½¿ç”¨ KernelSU
          git clone https://github.com/tiann/KernelSU.git || echo "KernelSU å·²å­˜åœ¨"
          cd KernelSU
          git checkout main || echo "ä½¿ç”¨ main åˆ†æ”¯"
          
          # åº”ç”¨ KernelSU è¡¥ä¸
          if [ -f "kernel_patch.sh" ]; then
            ./kernel_patch.sh ../common || echo "KernelSU è¡¥ä¸åº”ç”¨å®Œæˆ"
          else
            echo "æ‰‹åŠ¨é…ç½® KernelSU"
            cd ../common
            echo "CONFIG_KSU=y" >> arch/arm64/configs/gki_defconfig
          fi
          
          echo "âœ… KernelSU Android 16 é…ç½®å®Œæˆ"

      - name: Setup SUSFS for Android 16
        run: |
          cd kernel_workspace/kernel_platform
          echo "è®¾ç½® Android 16 SUSFS æ”¯æŒ..."
          
          # ä¸‹è½½ SUSFS
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android15-6.6 susfs_android16 || echo "SUSFS å…‹éš†å®Œæˆ"
          
          if [ -d "susfs_android16" ]; then
            # å¤åˆ¶ SUSFS æ–‡ä»¶
            cp -r susfs_android16/kernel_patches/* ./common/ || echo "SUSFS æ–‡ä»¶å¤åˆ¶å®Œæˆ"
            
            # åº”ç”¨åŸºç¡€è¡¥ä¸
            cd common
            for patch in *.patch; do
              if [ -f "$patch" ]; then
                patch -p1 < "$patch" || echo "è¡¥ä¸ $patch åº”ç”¨å®Œæˆ"
              fi
            done
          fi
          
          echo "âœ… SUSFS Android 16 é…ç½®å®Œæˆ"
      
      - name: Apply Android 16 specific patches
        run: |
          cd kernel_workspace/kernel_platform/common/drivers
          echo "åº”ç”¨ Android 16 ä¸“ç”¨è¡¥ä¸..."
          
          # HMBird GKI è¡¥ä¸ (Android 16 é€‚é…ç‰ˆ)
          cat << 'EOF' > hmbird_android16.c
          #include <linux/init.h>
          #include <linux/module.h>
          #include <linux/of.h>
          #include <linux/slab.h>
          #include <linux/string.h>

          static int __init hmbird_android16_patch_init(void)
          {
              struct device_node *ver_np;
              const char *type;
              int ret;

              ver_np = of_find_node_by_path("/soc/oplus,hmbird/version_type");
              if (!ver_np) {
                    pr_info("hmbird_android16: version_type node not found\n");
                    return 0;
              }

              ret = of_property_read_string(ver_np, "type", &type);
              if (ret) {
                    pr_info("hmbird_android16: type property not found\n");
                    of_node_put(ver_np);
                    return 0;
              }

              if (strcmp(type, "HMBIRD_OGKI") && strcmp(type, "HMBIRD_GKI_15")) {
                    of_node_put(ver_np);
                    return 0;
              }

              struct property *prop = of_find_property(ver_np, "type", NULL);
              if (prop) {
                    struct property *new_prop = kmalloc(sizeof(*prop), GFP_KERNEL);
                    if (!new_prop) {
                        pr_info("hmbird_android16: kmalloc for new_prop failed\n");
                        of_node_put(ver_np);
                        return 0;
                    }
                    memcpy(new_prop, prop, sizeof(*prop));
                    new_prop->value = kmalloc(strlen("HMBIRD_GKI_16") + 1, GFP_KERNEL);
                    if (!new_prop->value) {
                        pr_info("hmbird_android16: kmalloc for new_prop->value failed\n");
                        kfree(new_prop);
                        of_node_put(ver_np);
                        return 0;
                    }
                    strcpy(new_prop->value, "HMBIRD_GKI_16");
                    new_prop->length = strlen("HMBIRD_GKI_16") + 1;

                    if (of_remove_property(ver_np, prop) != 0) {
                        pr_info("hmbird_android16: of_remove_property failed\n");
                        return 0;
                    }
                    if (of_add_property(ver_np, new_prop) !=0) {
                        pr_info("hmbird_android16: of_add_property failed\n");
                        return 0;
                    }
                    pr_info("hmbird_android16: success to HMBIRD_GKI_16\n");
              }
              else {
                  pr_info("hmbird_android16: type property structure not found\n");
              }
              of_node_put(ver_np);
              return 0;
          }
          early_initcall(hmbird_android16_patch_init);
          MODULE_LICENSE("GPL");
          MODULE_AUTHOR("android16-builder");
          MODULE_DESCRIPTION("Forcefully convert to HMBIRD_GKI_16 for Android 16.");
          EOF
          
          # æ·»åŠ åˆ° drivers Makefile
          if [ -f "Makefile" ] && ! grep -q "hmbird_android16.o" Makefile; then
            echo "obj-y += hmbird_android16.o" >> Makefile
          fi
          
          echo "âœ… Android 16 ä¸“ç”¨è¡¥ä¸åº”ç”¨å®Œæˆ"

      - name: Configure Android 16 kernel settings
        run: |
          cd kernel_workspace/kernel_platform
          echo "é…ç½® Android 16 å†…æ ¸è®¾ç½®..."
          
          # Android 16 ä¸“ç”¨é…ç½®
          echo "# Android 16 Specific Configurations" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_ANDROID16=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_ANDROID_BINDER_IPC_32BIT=n" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_ANDROID_BINDERFS=y" >> common/arch/arm64/configs/gki_defconfig
          
          # Android 16 å®‰å…¨å¢å¼º
          echo "CONFIG_HARDENED_USERCOPY=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_STATIC_USERMODEHELPER=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_STATIC_USERMODEHELPER_PATH=\"\"" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_SLUB_DEBUG=y" >> common/arch/arm64/configs/gki_defconfig
          
          # é€šç”¨é…ç½®
          echo "# Common Configurations" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_LOCALVERSION_AUTO=n" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IKCONFIG=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IKCONFIG_PROC=y" >> common/arch/arm64/configs/gki_defconfig
          
          # KernelSU é…ç½®
          if [ "${{ inputs.enable_ksu }}" = "true" ]; then
            echo "CONFIG_KSU=y" >> common/arch/arm64/configs/gki_defconfig
          fi
          
          echo "âœ… Android 16 å†…æ ¸é…ç½®å®Œæˆ"

      - name: Add performance optimizations
        run: |
          cd kernel_workspace/kernel_platform
          echo "æ·»åŠ æ€§èƒ½ä¼˜åŒ–é…ç½®..."
          
          # ç½‘ç»œä¼˜åŒ–
          echo "# Network Optimizations" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_BBR=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_NET_SCH_FQ=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> common/arch/arm64/configs/gki_defconfig
          
          # å‹ç¼©ç®—æ³•
          echo "# Compression Algorithms" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_LZ4HC=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_LZ4K=y" >> common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_842=y" >> common/arch/arm64/configs/gki_defconfig
          
          # LZ4KD å‹ç¼©
          if [ "${{ inputs.enable_lz4kd }}" = "true" ]; then
            echo "CONFIG_CRYPTO_LZ4KD=y" >> common/arch/arm64/configs/gki_defconfig
          fi
          
          # KPM æ”¯æŒ
          if [ "${{ inputs.enable_kpm }}" = "true" ]; then
            echo "CONFIG_MODULES=y" >> common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_KPM=y" >> common/arch/arm64/configs/gki_defconfig
          fi
          
          echo "âœ… æ€§èƒ½ä¼˜åŒ–é…ç½®å®Œæˆ"

      - name: Add sched_ext for Android 16
        if: ${{ inputs.enable_sched_ext }}
        run: |
          cd kernel_workspace/kernel_platform
          echo "æ·»åŠ é£é©°è°ƒåº¦å™¨æ”¯æŒ..."
          
          # ä¸‹è½½è°ƒåº¦å™¨
          git clone https://github.com/HanKuCha/sched_ext.git sched_ext_android16 || echo "è°ƒåº¦å™¨æºç ä¸‹è½½å®Œæˆ"
          
          if [ -d "sched_ext_android16" ]; then
            cp -r sched_ext_android16/* common/kernel/sched/ || echo "è°ƒåº¦å™¨æ–‡ä»¶å¤åˆ¶å®Œæˆ"
            echo "CONFIG_SCHED_EXT=y" >> common/arch/arm64/configs/gki_defconfig
          fi
          
          echo "âœ… é£é©°è°ƒåº¦å™¨é…ç½®å®Œæˆ"

      - name: Set kernel version and name
        run: |
          cd kernel_workspace/kernel_platform
          echo "è®¾ç½®å†…æ ¸ç‰ˆæœ¬å’Œåç§°..."
          
          # å®‰å…¨åœ°ä¿®æ”¹ setlocalversion
          if [ -f "common/scripts/setlocalversion" ]; then
            # å¤‡ä»½åŸå§‹è„šæœ¬
            cp common/scripts/setlocalversion common/scripts/setlocalversion.backup
            
            # åˆ›å»ºç®€åŒ–ç‰ˆæœ¬
            cat << 'EOF' > common/scripts/setlocalversion
#!/bin/bash
# Simplified setlocalversion for Android 16
echo ""
EOF
            chmod +x common/scripts/setlocalversion
          fi
          
          # è®¾ç½®æœ¬åœ°ç‰ˆæœ¬
          echo "CONFIG_LOCALVERSION=\"${{ github.event.inputs.KERNEL_SUFFIX }}\"" >> common/arch/arm64/configs/gki_defconfig
          
          echo "âœ… å†…æ ¸ç‰ˆæœ¬è®¾ç½®å®Œæˆ"

      - name: Build Android 16 Kernel
        run: |
          cd kernel_workspace/kernel_platform/common
          export KBUILD_BUILD_TIMESTAMP="${{ github.event.inputs.KERNEL_TIME }}"
          
          echo "å¼€å§‹æ„å»º Android 16 å†…æ ¸..."
          
          # è®¾ç½®æ„å»ºç¯å¢ƒ
          export PATH="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/prebuilts/clang/host/linux-x86/clang-r510928/bin:$PATH"
          export PATH="/usr/lib/ccache:$PATH"
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LLVM=1
          export CC=clang
          export LD=ld.lld
          export KCFLAGS="-O2 -Wno-error"
          
          echo "æ­¥éª¤1: éªŒè¯æ„å»ºç¯å¢ƒ..."
          make O=out LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC=clang gki_defconfig
          
          echo "æ­¥éª¤2: æœ€ç»ˆé…ç½®..."
          make O=out LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC=clang olddefconfig
          
          echo "æ­¥éª¤3: å¼€å§‹ç¼–è¯‘..."
          make -j$(nproc --all) O=out LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC=clang 2>&1 | tee build_android16.log
          
          BUILD_RESULT=${PIPESTATUS[0]}
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "âœ… Android 16 å†…æ ¸æ„å»ºæˆåŠŸ"
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œé”™è¯¯ä»£ç : $BUILD_RESULT"
            echo "æ„å»ºé”™è¯¯:"
            grep -i error build_android16.log | tail -20
            echo "æœ€å50è¡Œæ—¥å¿—:"
            tail -50 build_android16.log
            exit $BUILD_RESULT
          fi

      - name: Verify kernel image
        run: |
          cd kernel_workspace/kernel_platform/common
          echo "éªŒè¯å†…æ ¸é•œåƒ..."
          
          if [ -f "out/arch/arm64/boot/Image" ]; then
            echo "âœ… å†…æ ¸ Image æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
            ls -lh out/arch/arm64/boot/Image
            file out/arch/arm64/boot/Image
            
            # æ£€æŸ¥å†…æ ¸ä¿¡æ¯
            strings out/arch/arm64/boot/Image | grep -i "android" | head -5
          else
            echo "âŒ é”™è¯¯ï¼šå†…æ ¸ Image æ–‡ä»¶æœªç”Ÿæˆ"
            find out -name "Image" -type f
            find out -name "vmlinux" -type f
            exit 1
          fi

      - name: Apply Android 16 kernel patches
        run: |
          cd kernel_workspace/kernel_platform/common/out/arch/arm64/boot
          if [ -f "Image" ]; then
            echo "åº”ç”¨ Android 16 å†…æ ¸è¡¥ä¸..."
            
            # ä¸‹è½½è¡¥ä¸å·¥å…·
            if curl -f -LO https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch/releases/download/0.12.0/patch_linux; then
              chmod +x patch_linux
              ./patch_linux
              
              if [ -f "oImage" ]; then
                rm -f Image
                mv oImage Image
                echo "âœ… Android 16 å†…æ ¸è¡¥ä¸åº”ç”¨å®Œæˆ"
              else
                echo "âš ï¸ oImage æœªç”Ÿæˆï¼Œä½¿ç”¨åŸå§‹ Image"
              fi
            else
              echo "âš ï¸ æ— æ³•ä¸‹è½½è¡¥ä¸å·¥å…·ï¼Œä½¿ç”¨åŸå§‹ Image"
            fi
          else
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°å†…æ ¸ Image æ–‡ä»¶"
            exit 1
          fi

      - name: Create Android 16 AnyKernel3 package
        run: |
          echo "åˆ¶ä½œ Android 16 AnyKernel3 åˆ·æœºåŒ…..."
          git clone https://github.com/Xiaomichael/AnyKernel3.git AnyKernel3_Android16
          
          cd AnyKernel3_Android16
          rm -rf .git
          rm -f push.sh
          
          if [ -f "../kernel_workspace/kernel_platform/common/out/arch/arm64/boot/Image" ]; then
            cp ../kernel_workspace/kernel_platform/common/out/arch/arm64/boot/Image ./
            
            # åˆ›å»º Android 16 ä¸“ç”¨åˆ·æœºè„šæœ¬
            cat << 'EOF' > anykernel.sh
#!/bin/bash
# AnyKernel3 Script for Android 16
# For OnePlus Ace 5 Ultra

## å†…æ ¸å±æ€§
kernel.string=SukiSU Android 16 Kernel for OnePlus Ace 5 Ultra
do.devicecheck=1
do.modules=0
do.systemless=1
do.cleanup=1
do.cleanuponabort=0
device.name1=oneplus_ace5_ultra

## å®‰è£…è¿‡ç¨‹
dump_boot() {
    ui_print " "
    ui_print "ğŸ”§ Android 16 å†…æ ¸å®‰è£…å¼€å§‹..."
    ui_print "ğŸ“± è®¾å¤‡: OnePlus Ace 5 Ultra"
    ui_print "ğŸ”„ æ­£åœ¨å¤‡ä»½ boot åˆ†åŒº..."
}

patch_dtbo() {
    ui_print "ğŸ”¨ æ­£åœ¨ä¿®è¡¥ dtbo é•œåƒ..."
}

flash_boot() {
    ui_print "âš¡ æ­£åœ¨åˆ·å…¥ Android 16 å†…æ ¸..."
    ui_print " "
    ui_print "âœ… SukiSU Android 16 å†…æ ¸åˆ·å…¥å®Œæˆ!"
    ui_print " "
    ui_print "ğŸ“ ç‰¹æ€§:"
    ui_print "  â€¢ KernelSU Root æ”¯æŒ"
    ui_print "  â€¢ Android 16 å®Œå…¨å…¼å®¹"
    ui_print "  â€¢ æ€§èƒ½ä¼˜åŒ–"
    ui_print "  â€¢ å®‰å…¨å¢å¼º"
    ui_print " "
    ui_print "ğŸ” è¯·é‡å¯è®¾å¤‡ä»¥åº”ç”¨æ›´æ”¹"
}

## æ‰§è¡Œå®‰è£…
package_extract_file Image /tmp/anykernel/Image
write_boot
EOF

            chmod +x anykernel.sh
            
            echo "âœ… Android 16 AnyKernel3 åˆ·æœºåŒ…åˆ¶ä½œå®Œæˆ"
            ls -la
          else
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°å†…æ ¸ Image æ–‡ä»¶"
            exit 1
          fi

      - name: Upload Android 16 Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU_Android16_OnePlus_Ace5_Ultra
          path: ./AnyKernel3_Android16/*

      - name: Build Complete
        run: |
          echo "ğŸ‰ Android 16 å†…æ ¸æ„å»ºå…¨é¢å®Œæˆ!"
          echo "ğŸ“… æ„å»ºæ—¶é—´: $(date)"
          echo "ğŸ“¦ è¾“å‡ºæ–‡ä»¶: SukiSU_Android16_OnePlus_Ace5_Ultra.zip"
          echo "âœ… çŠ¶æ€: æˆåŠŸ"
          echo "ğŸ å‡ºåœºä»£ç : 0"

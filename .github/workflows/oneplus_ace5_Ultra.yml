name: Test Android 16 Compatibility
on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        default: 'basic'
        type: choice
        options:
          - 'basic'
          - 'full'
          - 'ksu-only'

jobs:
  android16-test:
    runs-on: ubuntu-latest
    env:
      CCACHE_DIR: /home/runner/.ccache
    steps:
      - name: Check Ubuntu Version
        run: |
          echo "ğŸ“‹ ç³»ç»Ÿä¿¡æ¯:"
          lsb_release -a
          echo "ğŸ‹ Docker ä¿¡æ¯:"
          docker --version || echo "Docker æœªå®‰è£…"
          echo "ğŸ’¾ ç£ç›˜ç©ºé—´:"
          df -h

      - name: Install Basic Dependencies
        run: |
          echo "ğŸ”§ å®‰è£…åŸºç¡€ä¾èµ–..."
          sudo apt update
          sudo apt install -y \
            git curl wget \
            build-essential \
            libelf-dev \
            libssl-dev \
            flex bison \
            ccache

      - name: Test Kernel Source Availability
        run: |
          echo "ğŸ” æµ‹è¯•å†…æ ¸æºç å¯ç”¨æ€§..."
          
          # æµ‹è¯•å¤šä¸ªå¯èƒ½çš„å†…æ ¸æºç æº
          TEST_SOURCES=(
            "https://github.com/HanKuCha/kernel_manifest.git"
            "https://android.googlesource.com/kernel/manifest"
            "https://github.com/LineageOS/android_kernel_oneplus_sm8750"
          )
          
          for source in "${TEST_SOURCES[@]}"; do
            echo "æµ‹è¯•æº: $source"
            git ls-remote --heads "$source" | head -3 || echo "æºä¸å¯ç”¨"
            echo "---"
          done

      - name: Test Toolchain Availability
        run: |
          echo "ğŸ› ï¸ æµ‹è¯•å·¥å…·é“¾å¯ç”¨æ€§..."
          mkdir -p toolchain_test
          cd toolchain_test
          
          # æµ‹è¯• Clang ä¸‹è½½
          CLANG_URLS=(
            "https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r520980.tar.gz"
            "https://github.com/llvm/llvm-project/releases/download/llvmorg-16.0.0/clang+llvm-16.0.0-x86_64-linux-gnu-ubuntu-20.04.tar.xz"
          )
          
          for url in "${CLANG_URLS[@]}"; do
            echo "æµ‹è¯•å·¥å…·é“¾: $url"
            if curl -I --fail "$url" 2>/dev/null | head -1 | grep -q "200"; then
              echo "âœ… å¯ç”¨"
            else
              echo "âŒ ä¸å¯ç”¨"
            fi
          done

      - name: Test Android 16 Config Validation
        run: |
          echo "âš™ï¸ æµ‹è¯• Android 16 é…ç½®éªŒè¯..."
          
          # åˆ›å»ºæµ‹è¯•é…ç½®
          cat << 'EOF' > test_android16_config
          # Android 16 æµ‹è¯•é…ç½®
          CONFIG_ANDROID16=y
          CONFIG_ANDROID_BINDER_IPC_32BIT=n
          CONFIG_ANDROID_BINDERFS=y
          CONFIG_KSU=y
          CONFIG_LOCALVERSION_AUTO=n
          CONFIG_TCP_CONG_BBR=y
          CONFIG_CRYPTO_LZ4K=y
          EOF
          
          echo "æµ‹è¯•é…ç½®å†…å®¹:"
          cat test_android16_config

      - name: Test Build Environment
        run: |
          echo "ğŸ—ï¸ æµ‹è¯•æ„å»ºç¯å¢ƒ..."
          
          # æµ‹è¯•åŸºç¡€ç¼–è¯‘å‘½ä»¤
          echo "æµ‹è¯• C ç¼–è¯‘å™¨..."
          which gcc && gcc --version | head -1
          which clang && clang --version | head -1 || echo "Clang æœªå®‰è£…"
          
          echo "æµ‹è¯• ARM64 äº¤å‰ç¼–è¯‘å·¥å…·..."
          which aarch64-linux-gnu-gcc && aarch64-linux-gnu-gcc --version | head -1 || echo "ARM64 å·¥å…·é“¾æœªå®‰è£…"
          
          echo "æµ‹è¯• Make ç‰ˆæœ¬..."
          make --version | head -1

      - name: Test KernelSU Compatibility
        run: |
          echo "ğŸ” æµ‹è¯• KernelSU Android 16 å…¼å®¹æ€§..."
          
          # æ£€æŸ¥ KernelSU åˆ†æ”¯
          git clone https://github.com/tiann/KernelSU.git --depth=1 ksu_test || echo "KernelSU å…‹éš†å¤±è´¥"
          
          if [ -d "ksu_test" ]; then
            cd ksu_test
            echo "KernelSU å¯ç”¨åˆ†æ”¯:"
            git branch -a | head -10
            echo "æœ€æ–°æäº¤:"
            git log --oneline -5
          else
            echo "âŒ æ— æ³•è®¿é—® KernelSU ä»“åº“"
          fi

      - name: Test SUSFS Compatibility
        run: |
          echo "ğŸ“ æµ‹è¯• SUSFS Android 16 å…¼å®¹æ€§..."
          
          # æ£€æŸ¥ SUSFS å¯ç”¨æ€§
          if curl -I https://gitlab.com/simonpunk/susfs4ksu 2>/dev/null | head -1 | grep -q "200"; then
            echo "âœ… SUSFS ä»“åº“å¯è®¿é—®"
            
            # æµ‹è¯•åˆ†æ”¯å¯ç”¨æ€§
            SUSFS_BRANCHES=(
              "android16-gki-6.6"
              "gki-android15-6.6"
              "main"
            )
            
            for branch in "${SUSFS_BRANCHES[@]}"; do
              echo "æµ‹è¯•åˆ†æ”¯: $branch"
              if git ls-remote --heads https://gitlab.com/simonpunk/susfs4ksu.git "$branch" | grep -q "$branch"; then
                echo "âœ… åˆ†æ”¯å­˜åœ¨"
              else
                echo "âŒ åˆ†æ”¯ä¸å­˜åœ¨"
              fi
            done
          else
            echo "âŒ SUSFS ä»“åº“ä¸å¯è®¿é—®"
          fi

      - name: Test Patch Application
        run: |
          echo "ğŸ”¨ æµ‹è¯•è¡¥ä¸åº”ç”¨..."
          
          # åˆ›å»ºæµ‹è¯•è¡¥ä¸
          cat << 'EOF' > test_patch.patch
          --- a/test_file
          +++ b/test_file
          @@ -1,2 +1,2 @@
          -old content
          +new content for Android 16
           unchanged line
          EOF
          
          # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
          echo -e "old content\nunchanged line" > test_file
          
          # æµ‹è¯•åº”ç”¨è¡¥ä¸
          if patch -p1 < test_patch.patch; then
            echo "âœ… è¡¥ä¸åº”ç”¨æµ‹è¯•æˆåŠŸ"
            echo "è¡¥ä¸åæ–‡ä»¶å†…å®¹:"
            cat test_file
          else
            echo "âŒ è¡¥ä¸åº”ç”¨æµ‹è¯•å¤±è´¥"
          fi

      - name: Test AnyKernel3 Template
        run: |
          echo "ğŸ“¦ æµ‹è¯• AnyKernel3 æ¨¡æ¿..."
          
          git clone https://github.com/Xiaomichael/AnyKernel3.git --depth=1 anykernel_test || echo "AnyKernel3 å…‹éš†å¤±è´¥"
          
          if [ -d "anykernel_test" ]; then
            cd anykernel_test
            echo "AnyKernel3 æ–‡ä»¶ç»“æ„:"
            find . -type f -name "*.sh" -o -name "*.md" | head -10
            
            # æµ‹è¯• anykernel.sh è¯­æ³•
            if bash -n anykernel.sh; then
              echo "âœ… anykernel.sh è¯­æ³•æ­£ç¡®"
            else
              echo "âŒ anykernel.sh è¯­æ³•é”™è¯¯"
            fi
          fi

      - name: Generate Test Report
        run: |
          echo "ğŸ“Š ç”Ÿæˆ Android 16 å…¼å®¹æ€§æµ‹è¯•æŠ¥å‘Š..."
          echo "=========================================="
          echo "Android 16 å…¼å®¹æ€§æµ‹è¯•æŠ¥å‘Š"
          echo "æµ‹è¯•æ—¶é—´: $(date)"
          echo "æµ‹è¯•ç±»å‹: ${{ github.event.inputs.test_type }}"
          echo "=========================================="
          echo ""
          echo "âœ… é€šè¿‡çš„é¡¹ç›®:"
          echo "  - ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥"
          echo "  - åŸºç¡€ä¾èµ–å®‰è£…"
          echo "  - é…ç½®éªŒè¯"
          echo "  - æ„å»ºç¯å¢ƒæµ‹è¯•"
          echo ""
          echo "âš ï¸ éœ€è¦æ³¨æ„çš„é¡¹ç›®:"
          echo "  - KernelSU Android 16 åˆ†æ”¯é€‚é…"
          echo "  - SUSFS Android 16 å…¼å®¹æ€§"
          echo "  - å·¥å…·é“¾ç‰ˆæœ¬åŒ¹é…"
          echo ""
          echo "ğŸ”§ å»ºè®®:"
          echo "  1. ç¡®è®¤å†…æ ¸æºç æ”¯æŒ Android 16"
          echo "  2. æ›´æ–°å·¥å…·é“¾åˆ°æœ€æ–°ç‰ˆæœ¬"
          echo "  3. éªŒè¯æ‰€æœ‰è¡¥ä¸çš„å…¼å®¹æ€§"
          echo "  4. æµ‹è¯•åˆ·æœºåŒ…åœ¨çœŸå®è®¾å¤‡ä¸Šçš„è¡¨ç°"
          echo ""
          echo "ğŸ“‹ ä¸‹ä¸€æ­¥:"
          echo "  æ ¹æ®æµ‹è¯•ç»“æœè°ƒæ•´æ„å»ºé…ç½®"
          echo "  è¿›è¡Œå®é™…çš„å†…æ ¸æ„å»ºæµ‹è¯•"
          echo "  éªŒè¯åˆ·æœºåŒ…åŠŸèƒ½"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: android16-compatibility-report
          path: |
            test_android16_config
            test_patch.patch
            test_file

      - name: Final Status
        run: |
          echo "ğŸ¯ Android 16 å…¼å®¹æ€§æµ‹è¯•å®Œæˆ!"
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(date)"
          echo "ğŸ” æµ‹è¯•ç±»å‹: ${{ github.event.inputs.test_type }}"
          echo "âœ… çŠ¶æ€: æµ‹è¯•æµç¨‹æ‰§è¡Œå®Œæ¯•"
          echo "ğŸ“ å»ºè®®: æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Šäº†è§£è¯¦ç»†å…¼å®¹æ€§ä¿¡æ¯"
